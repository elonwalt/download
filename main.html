<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiktok</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" href="assets/img/tiktok.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <script src="https://kit.fontawesome.com/d829d3809c.js" crossorigin="anonymous"></script>
</head>

<body>
    <!-- ph·∫ßn logo -->
    <img class="logo" src="./assets/img/TikTok_logo.svg.png" alt="">
    <!--end ph·∫ßn logo -->


    <!-- th√¥ng tin user -->
    <div class="container">
        <div class="vid">
            <video crossorigin="use-credentials" preload="" playsinline controls autoplay id="videoPlayer"
                src=""></video>
            <div class="option3">
                <button class="couttim chiso" style="color: white;"></button>
                <span class="countCmt2 chiso" style="color: white;"></span>
                <span class="countShares chiso" style="color: white;"></span>
            </div>
            <div class="option">
                <button id="previousButton"><i class="fa-solid fa-up-long"></i></button>
                <button id="nextButton"><i class="fa-solid fa-down-long"></i></button>
            </div>
            <div class="option2">
                <button class="heart-button"><i class="fa-solid fa-heart"></i></button>
                <button class="cmt"><i class="fa-regular fa-comment-dots"></i></button>
                <button><i class="fa-solid fa-share-nodes"></i></button>
            </div>

            <div class="comment">
                <div class="hr"></div>
                <div class="avt">
                    <div>
                        <img class="avturl" src="" alt="">
                    </div>
                    <div style="width: 70%;" class="profile">
                        <div class="name"></div>
                        <div class="username"></div>
                    </div>
                    <!-- Th√™m thu·ªôc t√≠nh data-video-id v√†o ph·∫ßn t·ª≠ .fl -->
                    <div style="width: 30%;" class="fl" data-video-id="1">
                        Follow
                    </div>
                </div>
                <div class="hr"></div>
                <div class="des">
                </div>
                <div class="nhacnen">
                    <i class="fa-solid fa-music"></i>
                    <p class="music fz"></p>
                </div>
                <!--end th√¥ng tin user -->

                <!-- ph·∫ßn comment -->
                <div class="containercmt">
                    <p class="countCmt"></p>
                    <div class="flcmt">
                        <div class="avtcmt">
                            <img src="./assets/img/logo.png" alt="">
                        </div>
                        <form id="commentForm">

                            <input type="text" id="commentInput" placeholder="Add comment...">
                            <div class="icon">
                                <i title="T√¨m ki·∫øm" class="fa-regular fa-face-smile" id="iconButton"></i>
                            </div>
                            <button id="submitButton" type="submit">Post</button>
                        </form>

                    </div>
                    <div class="icon-list" id="iconList">
                        <i>üòÄ</i>
                        <i>üòÑ</i>
                        <i>üòÅ</i>
                        <i>üòÜ</i>
                        <i>üòÖ</i>
                        <i>ü§£</i>
                        <i>üòÇ</i>
                        <i>üôÇ</i>
                        <i>üôÉ</i>
                        <i>ü´†</i>
                        <i>üòâ</i>
                        <i>üòä</i>
                        <i>üòá</i>
                    </div><br>
                    <div class="hr"></div>
                    <div class="cmtdown cmtdown-grid" id="commentsContainer"></div>
                    <button style="background-color: brown;">Logout</button>
                </div>
                <!--end ph·∫ßn comment -->
            </div>
        </div>
    </div>

    <script>
        // L·∫•y ph·∫ßn t·ª≠ .fl
        const followButton = document.querySelector('.fl');

        // L·∫•y id video t·ª´ thu·ªôc t√≠nh data-video-id
        const videoId = followButton.dataset.videoId;

        // L·∫•y t·∫•t c·∫£ c√°c name ƒë√£ ƒë∆∞·ª£c l∆∞u trong local storage
        let savedNames = JSON.parse(localStorage.getItem('savedNames')) || [];

        // Ki·ªÉm tra xem class 'name' ƒë√£ t·ªìn t·∫°i trong m·∫£ng savedNames hay kh√¥ng
        const isFollowed = savedNames.includes(getCurrentName());

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i ban ƒë·∫ßu c·ªßa n√∫t follow
        updateFollowButtonState(isFollowed);

        // Th√™m s·ª± ki·ªán click cho n√∫t follow
        followButton.addEventListener('click', function () {
            const currentName = getCurrentName();
            const index = savedNames.indexOf(currentName);

            if (index === -1) {
                // Th√™m name v√†o m·∫£ng savedNames
                savedNames.push(currentName);

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t follow
                updateFollowButtonState(true);
            } else {
                // X√≥a name kh·ªèi m·∫£ng savedNames
                savedNames.splice(index, 1);

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t follow
                updateFollowButtonState(false);
            }

            // L∆∞u m·∫£ng savedNames v√†o local storage
            localStorage.setItem('savedNames', JSON.stringify(savedNames));
        });

        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t follow
        function updateFollowButtonState(isFollowed) {
            if (isFollowed) {
                followButton.textContent = 'Unfollow';
                followButton.classList.add('unfollow');
            } else {
                followButton.textContent = 'Follow';
                followButton.classList.remove('unfollow');
            }
        }

        // H√†m l·∫•y gi√° tr·ªã c·ªßa class 'name'
        function getCurrentName() {
            const nameElement = document.querySelector('.name');
            return nameElement.textContent.trim();
        }

        // L·∫Øng nghe s·ª± ki·ªán "timeupdate" c·ªßa video
        const videoElement = document.getElementById('videoPlayer');
        videoElement.addEventListener('timeupdate', handleVideoTimeUpdate);

        // H√†m x·ª≠ l√Ω s·ª± ki·ªán "timeupdate" c·ªßa video
        function handleVideoTimeUpdate() {
            const currentName = getCurrentName();
            const isFollowed = savedNames.includes(currentName);
            updateFollowButtonState(isFollowed);
        }
    </script>
    <script>
        // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng t·ª´ localStorage
        const user = JSON.parse(localStorage.getItem('user'));

        // Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p hay ch∆∞a
        if (user) {
            // L·∫•y tham chi·∫øu t·ªõi ph·∫ßn t·ª≠ img trong class "avtcmt"
            const avtcmtImg = document.querySelector('.avtcmt img');

            // ƒê·∫∑t ƒë∆∞·ªùng d·∫´n ·∫£nh t·ª´ URL l∆∞u trong th√¥ng tin ng∆∞·ªùi d√πng
            avtcmtImg.src = user.avturl;
        }
        // G√°n s·ª± ki·ªán submit cho form Comment
        commentForm.addEventListener('submit', function (event) {
            event.preventDefault(); // NgƒÉn ch·∫∑n s·ª± ki·ªán submit m·∫∑c ƒë·ªãnh c·ªßa form

            // L·∫•y d·ªØ li·ªáu "name" t·ª´ Local Storage

            const storedUser = JSON.parse(localStorage.getItem('user'));
            const storedName = storedUser.name;
            // Ki·ªÉm tra xem d·ªØ li·ªáu "name" c√≥ t·ªìn t·∫°i kh√¥ng
            if (storedUser && storedUser.name) {
                const storedName = storedUser.name;

                if (commentText !== '') {
                    // T·∫°o ƒë·ªëi t∆∞·ª£ng ch·ª©a th√¥ng tin b√¨nh lu·∫≠n
                    const newComment = {
                        text: commentText,
                        name: storedName
                        // Th√™m c√°c tr∆∞·ªùng d·ªØ li·ªáu kh√°c c·ªßa b√¨nh lu·∫≠n (n·∫øu c√≥)
                    };

                    // G·ª≠i b√¨nh lu·∫≠n m·ªõi l√™n c∆° s·ªü d·ªØ li·ªáu
                    axios.post('https://video-data.vercel.app/comments')
                        // axios.post('http://localhost:3000/comments', newComment)
                        .then(response => {
                            // X·ª≠ l√Ω khi b√¨nh lu·∫≠n ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng
                            console.log('Comment posted:', response.data);

                            // Sau khi b√¨nh lu·∫≠n ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng, b·∫°n c√≥ th·ªÉ l√†m nh·ªØng vi·ªác kh√°c nh∆∞ c·∫≠p nh·∫≠t hi·ªÉn th·ªã b√¨nh lu·∫≠n, t·∫£i l·∫°i danh s√°ch b√¨nh lu·∫≠n, v.v.
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });

                    // X√≥a n·ªôi dung trong input comment
                    commentInput.value = '';
                }
            }
        });
    </script>


    <!-- x·ª≠ l√Ω logic -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            $("#iconButton").click(function () {
                $("#iconList").toggle();
            });

            $(".icon-list i").click(function () {
                var emoji = $(this).text();
                $("#commentInput").val($("#commentInput").val() + emoji + " ");
                $("#iconList").hide();
            });
        });

        $(window).on('load', function () {
            $("#iconList").hide();
        });
    </script>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        // L·∫•y tham chi·∫øu t·ªõi c√°c ph·∫ßn t·ª≠ DOM
        const videoPlayer = document.getElementById('videoPlayer');
        const previousButton = document.getElementById('previousButton');
        const nextButton = document.getElementById('nextButton');
        const commentForm = document.getElementById('commentForm');
        const commentInput = document.getElementById('commentInput');
        const commentsContainer = document.getElementById('commentsContainer');
        const countCmt = document.querySelector('.countCmt');
        const countCmt2 = document.querySelector('.countCmt2');
        // Kh·ªüi t·∫°o bi·∫øn l∆∞u tr·ªØ danh s√°ch video
        let videoList = [];

        // L·∫•y d·ªØ li·ªáu t·ª´ API
        function fetchVideoData() {
            //   axios.get('http://localhost:3000/videos')
            axios.get('https://video-data.vercel.app/videos')
                .then(response => {
                    // G√°n danh s√°ch video t·ª´ API v√†o bi·∫øn videoList
                    videoList = response.data;
                    showVideo(0);
                    fetchComments(videoList[0].comments);
                    fillData(videoList[0]); // G·ªçi h√†m fillData ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu video
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // hi·ªáu ·ª©ng tr√°i tim
        const heartButton = document.querySelector('.heart-button');
        let isClicked = false;

        heartButton.addEventListener('click', function () {
            isClicked = !isClicked;
            heartButton.querySelector('i').classList.toggle('clicked', isClicked);
        });

        // Hi·ªÉn th·ªã video
        function showVideo(index) {
            const video = videoList[index];
            videoPlayer.src = video.url;
            currentVideoIndex = index;
            fetchComments(video.comments);
            fillData(video); // G·ªçi h√†m fillData ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu video
        }

        function fillData(video) {
            document.getElementById('videoPlayer').src = video.url;

            const nameElements = document.getElementsByClassName('name');
            for (let i = 0; i < nameElements.length; i++) {
                nameElements[i].innerText = video.name;
            }

            const usernameElements = document.getElementsByClassName('username');
            for (let i = 0; i < usernameElements.length; i++) {
                usernameElements[i].innerText = video.username;
            }

            const desElements = document.getElementsByClassName('des');
            for (let i = 0; i < desElements.length; i++) {
                desElements[i].innerHTML = video.des;
            }

            const musicElements = document.getElementsByClassName('music');
            for (let i = 0; i < musicElements.length; i++) {
                musicElements[i].innerHTML = video.music;
            }

            const avtElements = document.getElementsByClassName('avturl');
            for (let i = 0; i < avtElements.length; i++) {
                const img = avtElements[i];
                img.src = video.avturl;
            }

            const likeCountElement = document.querySelector('.couttim');
            likeCountElement.innerText = video.likes;

            const commentCountElement = document.querySelector('.countCmt2');
            commentCountElement.innerText = video.comments.length;

            const shareCountElement = document.querySelector('.countShares');
            shareCountElement.innerText = video.shares;
        }
        // L·∫•y danh s√°ch b√¨nh lu·∫≠n t·ª´ API
        function fetchComments(commentIds) {
            // axios.get('http://localhost:3000/comments')
            axios.get('https://video-data.vercel.app/comments')
                .then(response => {
                    const comments = response.data;
                    const videoComments = comments.filter(comment => commentIds.includes(comment.id));
                    displayComments(videoComments);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }


        function displayComments(comments) {
            commentsContainer.innerHTML = '';

            for (let i = 0; i < comments.length; i++) {
                const comment = comments[i];

                const div = document.createElement('div');
                div.classList.add('comment-wrapper'); // Th√™m class t√πy ch·ªânh cho th·∫ª <div> (n·∫øu c·∫ßn)

                const avatar = document.createElement('img');
                avatar.src = comment.avturl;
                avatar.classList.add('avatar');

                const infoDiv = document.createElement('div');
                infoDiv.classList.add('comment-info'); // Th√™m class t√πy ch·ªânh cho ph·∫ßn th√¥ng tin (n·∫øu c·∫ßn)

                const liName = document.createElement('li');
                liName.innerText = `${comment.name}`;
                liName.classList.add('usercmt')

                const liText = document.createElement('li');
                liText.innerText = `${comment.text}`;
                liText.classList.add('textcmt')

                const liTime = document.createElement('li');
                liTime.innerText = `${comment.date}`;
                liTime.classList.add('timecmt')

                const like = document.createElement('li');
                like.innerText = `${comment.likes}`;
                like.classList.add('like')

                const share = document.createElement('li');
                share.innerText = `${comment.shares}`;
                share.classList.add('share')

                infoDiv.appendChild(liName);
                infoDiv.appendChild(liText);
                infoDiv.appendChild(liTime);

                div.appendChild(avatar);
                div.appendChild(infoDiv);
                commentsContainer.appendChild(div);
            }
            countCmt.textContent = comments.length + ' comment' + (comments.length !== 1 ? 's' : ''); // Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng b√¨nh lu·∫≠n

        }

        function getAvatarUrl(userId) {
            const video = videoList.find(video => video.id === userId);
            if (video) {
                return video.avturl; // L·∫•y ƒë∆∞·ªùng d·∫´n ·∫£nh t·ª´ tr∆∞·ªùng avturl c·ªßa d·ªØ li·ªáu video
            }
            return './assets/img/logo.png';
        }
        // G·ª≠i b√¨nh lu·∫≠n m·ªõi
        function postComment(videoId, commentText) {
            // L·∫•y d·ªØ li·ªáu "name" t·ª´ Local Storage
            const storedUser = JSON.parse(localStorage.getItem('user'));
            const storedName = storedUser ? storedUser.name : '';
            const storedAvturl = storedUser ? storedUser.avturl : '';
            const currentDate = new Date().toLocaleDateString(); // L·∫•y ng√†y hi·ªán t·∫°i

            axios
            // .post('http://localhost:3000/comments', { text: commentText, name: storedName, avturl: storedAvturl, date: currentDate })
            axios.post('https://video-data.vercel.app/comments', { text: commentText })
                .then(response => {
                    const newComment = response.data;
                    const video = videoList[currentVideoIndex];
                    video.comments.push(newComment.id); // Th√™m ID b√¨nh lu·∫≠n v√†o m·∫£ng comments c·ªßa video hi·ªán t·∫°i
                    commentInput.value = '';
                    countCmt.textContent =
                        video.comments.length + ' comment' + (video.comments.length !== 1 ? 's' : ''); // Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng b√¨nh lu·∫≠n
                    // C·∫≠p nh·∫≠t b·∫£ng videos tr√™n API server
                    axios
                    // .put(`http://localhost:3000/videos/${videoId}`, video)
                    axios.put(`https://video-data.vercel.app/videos/${videoId}`, video)
                        .then(response => {
                            console.log('Video updated:', response.data);
                            fetchComments(video.comments); // G·ªçi l·∫°i fetchComments ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch b√¨nh lu·∫≠n
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        // Chuy·ªÉn video l√™n
        function playPreviousVideo() {
            if (currentVideoIndex > 0) {
                currentVideoIndex--;
                showVideo(currentVideoIndex);
            }
        }

        // Chuy·ªÉn video xu·ªëng
        function playNextVideo() {
            if (currentVideoIndex < videoList.length - 1) {
                currentVideoIndex++;
                showVideo(currentVideoIndex);
            }
        }

        // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng g·ª≠i b√¨nh lu·∫≠n
        function handleCommentSubmit(event) {
            event.preventDefault(); // NgƒÉn ch·∫∑n s·ª± ki·ªán submit m·∫∑c ƒë·ªãnh c·ªßa form
            const commentText = commentInput.value.trim();
            if (commentText !== '') {
                commentInput.disabled = true; // V√¥ hi·ªáu h√≥a input b√¨nh lu·∫≠n ƒë·ªÉ ngƒÉn ng∆∞·ªùi d√πng nh·∫≠p li·ªáu m·ªõi
                postComment(videoList[currentVideoIndex].id, commentText);
            }
        }

        // G√°n s·ª± ki·ªán click cho c√°c n√∫t chuy·ªÉn video
        // G√°n s·ª± ki·ªán click cho n√∫t Previous
        previousButton.addEventListener('click', function (event) {
            event.preventDefault(); // NgƒÉn ch·∫∑n s·ª± ki·ªán click m·∫∑c ƒë·ªãnh
            playPreviousVideo();
        });

        // G√°n s·ª± ki·ªán click cho n√∫t Next
        nextButton.addEventListener('click', function (event) {
            event.preventDefault(); // NgƒÉn ch·∫∑n s·ª± ki·ªán click m·∫∑c ƒë·ªãnh
            playNextVideo();
        });

        // G√°n s·ª± ki·ªán submit cho form Comment
        commentForm.addEventListener('submit', function (event) {
            event.preventDefault(); // NgƒÉn ch·∫∑n s·ª± ki·ªán submit m·∫∑c ƒë·ªãnh c·ªßa form
            handleCommentSubmit(event);
        });

        // L·∫•y d·ªØ li·ªáu video khi trang t·∫£i xong
        window.addEventListener('DOMContentLoaded', fetchVideoData);


        // L·∫•y tham chi·∫øu t·ªõi n√∫t "Logout"
        const logoutButton = document.querySelector('button[style="background-color: brown;"]');

        // G·∫Øn s·ª± ki·ªán click cho n√∫t "Logout"
        logoutButton.addEventListener('click', function () {
            // X√≥a d·ªØ li·ªáu trong Local Storage
            localStorage.clear();

            // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang "login.html"
            window.location.href = 'index.html';
        });
    </script>
</body>

</html>